name: Fedora RDP Server
on:
  workflow_dispatch:
jobs:
  fedora-rdp:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 3600

    steps:
    - name: Install and Setup xRDP
      run: |
        dnf update -y
        dnf install -y xrdp firewalld @xfce-desktop dbus-x11
        
        # ØªÙƒÙˆÙŠÙ† xRDP
        mkdir -p /home/TOOLBOXLAP/.config
        echo 'exec startxfce4' > /home/TOOLBOXLAP/.xinitrc
        chmod +x /home/TOOLBOXLAP/.xinitrc
        
        # ØªÙƒÙˆÙŠÙ† xRDP
        sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
        echo "[xfce]" >> /etc/xrdp/xrdp.ini
        echo "name=xfce" >> /etc/xrdp/xrdp.ini
        echo "lib=libxup.so" >> /etc/xrdp/xrdp.ini
        echo "username=ask" >> /etc/xrdp/xrdp.ini
        echo "password=ask" >> /etc/xrdp/xrdp.ini
        echo "ip=127.0.0.1" >> /etc/xrdp/xrdp.ini
        echo "port=-1" >> /etc/xrdp/xrdp.ini

    - name: Create RDP User
      run: |
        useradd -m -G wheel -s /bin/bash TOOLBOXLAP
        echo "TOOLBOXLAP:admin@123" | chpasswd
        echo "TOOLBOXLAP ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
        chown -R TOOLBOXLAP:TOOLBOXLAP /home/TOOLBOXLAP

    - name: Install Tailscale
      run: |
        dnf install -y curl
        curl -fsSL https://tailscale.com/install.sh | sh
        tailscale up --auth-key=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=fedora-rdp-$GITHUB_RUN_ID
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
        sleep 10
        TS_IP=$(tailscale ip -4)
        echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

    - name: Start RDP Services
      run: |
        # Ø¨Ø¯Ø¡ DBUS
        dbus-daemon --system --nofork --nopidfile &
        sleep 2
        
        # Ø¨Ø¯Ø¡ xRDP
        xrdp-sesman &
        sleep 2
        xrdp &
        sleep 5
        
        # ÙØªØ­ Ø§Ù„Ø¨ÙˆØ±Øª ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ
        firewall-cmd --add-port=3389/tcp --permanent 2>/dev/null || true
        firewall-cmd --reload 2>/dev/null || true

    - name: Verify RDP Accessibility
      run: |
        echo "ÙØ­Øµ Ø§ØªØµØ§Ù„ RDP Ø¹Ø¨Ø± Tailscale..."
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ RDP
        if command -v nc &> /dev/null; then
          dnf install -y nc
        fi
        nc -z localhost 3389 && echo "âœ… RDP port 3389 is listening" || echo "âŒ RDP port not listening"

    - name: Display Connection Details
      run: |
        echo " "
        echo "=== FEDORA RDP SERVER READY ==="
        echo "Tailscale IP: $TAILSCALE_IP"
        echo "Username: TOOLBOXLAP"
        echo "Password: admin@123"
        echo "Port: 3389"
        echo "Desktop: XFCE"
        echo " "
        echo "INSTRUCTIONS:"
        echo "1. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ù…ØªØµÙ„ Ø¨Ù†ÙØ³ Ø´Ø¨ÙƒØ© Tailscale"
        echo "2. Ø§ÙØªØ­ Remote Desktop Client"
        echo "3. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: $TAILSCALE_IP"
        echo "4. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¹Ù„Ø§Ù‡"
        echo "================================"
        echo " "

    - name: Keep Server Alive
      run: |
        echo "RDP Server is running via Tailscale..."
        # Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Tailscale
        echo "ðŸ“¡ Ø­Ø§Ù„Ø© Tailscale:"
        tailscale status
        
        echo "ðŸ”Œ Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ RDP:"
        netstat -tlnp | grep 3389 && echo "âœ… Port 3389 is open" || echo "âŒ Port 3389 is closed"
        
        counter=0
        while true; do
          echo "[$(date)] RDP Ù†Ø´Ø· - IP: $TAILSCALE_IP - User: TOOLBOXLAP"
          counter=$((counter + 1))
          # ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Tailscale
          if [ $((counter % 5)) -eq 0 ]; then
            TS_CURRENT_IP=$(tailscale ip -4)
            if [ "$TS_CURRENT_IP" != "$TAILSCALE_IP" ]; then
              echo "ðŸ”„ ØªØ­Ø¯ÙŠØ« Tailscale IP: $TS_CURRENT_IP"
              echo "TAILSCALE_IP=$TS_CURRENT_IP" >> $GITHUB_ENV
            fi
          fi
          sleep 60
        done
