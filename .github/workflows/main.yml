name: Fedora RDP with Ngrok
on:
  workflow_dispatch:
jobs:
  fedora-rdp:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 3600

    steps:
    - name: Install xRDP and Ngrok
      run: |
        dnf update -y
        dnf install -y xrdp xorg-x11-server-Xorg xterm wget

    - name: Create RDP User
      run: |
        useradd -m -s /bin/bash TOOLBOXLAP
        echo "TOOLBOXLAP:admin@123" | chpasswd

    - name: Configure and Start RDP
      run: |
        echo 'exec xterm' > /home/TOOLBOXLAP/.xinitrc
        chmod +x /home/TOOLBOXLAP/.xinitrc
        xrdp-sesman &
        xrdp &
        sleep 5

    - name: Setup Ngrok Tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp 3389 &
        sleep 10
        
        # الحصول على رابط Ngrok
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
        if [ -n "$NGROK_URL" ]; then
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
        else
          # إذا فشل الحصول على الرابط
          echo "NGROK_URL=tcp://ngrok-rdp-$GITHUB_RUN_ID" >> $GITHUB_ENV
        fi

    - name: Display Connection Info
      run: |
        echo " "
        echo "=== FEDORA RDP ==="
        echo "Connect to: $NGROK_URL"
        echo "Username: TOOLBOXLAP"
        echo "Password: admin@123"
        echo "==================="
        echo " "

    - name: Keep Alive
      run: |
        while true; do
          echo "[$(date)] RDP Active - URL: $NGROK_URL"
          sleep 60
        done
