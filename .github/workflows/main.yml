name: Fedora RDP Server
on:
  workflow_dispatch:
jobs:
  fedora-rdp:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 3600

    steps:
    - name: Install xRDP Only
      run: |
        dnf update -y
        dnf install -y xrdp firewalld

    - name: Create RDP User
      run: |
        useradd -m -G wheel -s /bin/bash TOOLBOXLAP
        echo "TOOLBOXLAP:admin@123" | chpasswd
        echo "TOOLBOXLAP ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

    - name: Install Tailscale
      run: |
        dnf install -y curl
        curl -fsSL https://tailscale.com/install.sh | sh
        tailscale up --auth-key=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=fedora-rdp-$GITHUB_RUN_ID
        
        # الانتظار للحصول على IP
        sleep 10
        TS_IP=$(tailscale ip -4)
        echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

    - name: Start RDP Services
      run: |
        # بدء xRDP
        systemctl enable xrdp
        systemctl enable xrdp-sesman
        systemctl start xrdp
        systemctl start xrdp-sesman
        
        # فتح البورت في الجدار الناري
        firewall-cmd --add-port=3389/tcp --permanent 2>/dev/null || true
        firewall-cmd --reload 2>/dev/null || true

    - name: Display Connection Details
      run: |
        echo " "
        echo "=== RDP SERVER READY ==="
        echo "IP: $TAILSCALE_IP"
        echo "Username: TOOLBOXLAP"
        echo "Password: admin@123"
        echo "Port: 3389"
        echo "========================="
        echo " "

    - name: Keep Server Alive
      run: |
        echo "RDP Server is running..."
        while true; do
          echo "[$(date)] IP: $TAILSCALE_IP | User: TOOLBOXLAP | Pass: admin@123 | Port: 3389"
          sleep 60
        done
