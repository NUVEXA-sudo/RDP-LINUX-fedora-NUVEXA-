name: cloudcore
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 99999

    steps:
      - name: Install Fedora and XRDP
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm virt-manager libvirt-daemon-system

      - name: Create Fedora VM
        run: |
          # Download Fedora Cloud image
          wget https://download.fedoraproject.org/pub/fedora/linux/releases/38/Cloud/x86_64/images/Fedora-Cloud-Base-38-1.6.x86_64.qcow2 -O fedora.qcow2
          
          # Create VM with QEMU
          qemu-img create -f qcow2 fedora-disk.qcow2 20G
          
          # Start Fedora VM in background
          nohup qemu-system-x86_64 \
            -hda fedora.qcow2 \
            -hdb fedora-disk.qcow2 \
            -m 2048 \
            -smp 2 \
            -netdev user,id=net0,hostfwd=tcp::3389-:3389 \
            -device virtio-net-pci,netdev=net0 \
            -vnc :0 \
            -daemonize

      - name: Configure Fedora RDP
        run: |
          # Wait for VM to boot and install xrdp
          sleep 60
          
          # Install xrdp and desktop environment
          sudo apt-get install -y xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Create user for RDP access
          sudo useradd -m -s /bin/bash fedorardp
          echo "fedorardp:fedora123" | sudo chpasswd
          sudo usermod -aG sudo fedorardp

      - name: Install and Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=fedora-rdp-${{ github.run_id }}

      - name: Get Tailscale IP
        run: |
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $env:GITHUB_ENV
          echo "RDP_IP=$TS_IP" >> $env:GITHUB_ENV

      - name: Infinite Loop to Keep Alive
        run: |
          echo "🎯 Fedora RDP System Ready!"
          echo "📍 RDP Address: ${{ env.TAILSCALE_IP }}"
          echo "👤 Username: fedorardp"
          echo "🔑 Password: fedora123"
          echo "🔄 System will remain active indefinitely..."
          echo ""
          echo "⏳ Starting infinite loop..."
          
          while true; do
            echo "$(date): 🔄 Fedora RDP Running... | IP: ${{ env.TAILSCALE_IP }}"
            sleep 300
          done
