name: Fedora RDP
on:
  workflow_dispatch:
jobs:
  fedora-rdp:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 3600

    steps:
    - name: Install xRDP
      run: |
        dnf update -y
        dnf install -y xrdp xorg-x11-server-Xorg xterm

    - name: Create RDP User
      run: |
        useradd -m -s /bin/bash TOOLBOXLAP
        echo "TOOLBOXLAP:admin@123" | chpasswd

    - name: Configure xRDP
      run: |
        echo 'exec xterm' > /home/TOOLBOXLAP/.xinitrc
        chmod +x /home/TOOLBOXLAP/.xinitrc
        chown TOOLBOXLAP:TOOLBOXLAP /home/TOOLBOXLAP/.xinitrc

    - name: Install Tailscale
      run: |
        dnf install -y curl
        curl -fsSL https://tailscale.com/install.sh | sh
        tailscale up --auth-key=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=fedora-rdp-$GITHUB_RUN_ID
        
        # الانتظار للحصول على IP
        sleep 10
        TS_IP=$(tailscale ip -4)
        echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

    - name: Start RDP Service
      run: |
        xrdp-sesman &
        sleep 2
        xrdp &
        sleep 5

    - name: Display RDP Connection Info
      run: |
        echo " "
        echo "=== FEDORA RDP CONNECTION ==="
        echo "IP: $TAILSCALE_IP"
        echo "Username: TOOLBOXLAP"
        echo "Password: admin@123"
        echo "Port: 3389"
        echo "============================="
        echo " "

    - name: Keep Server Alive
      run: |
        while true; do
          echo "[$(date)] RDP Active - IP: $TAILSCALE_IP | User: TOOLBOXLAP | Pass: admin@123"
          sleep 60
        done
